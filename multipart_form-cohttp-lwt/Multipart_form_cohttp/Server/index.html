<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Server (multipart_form-cohttp-lwt.Multipart_form_cohttp.Server)</title><link rel="stylesheet" href="../../../_odoc_support/odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 2.1.1"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">multipart_form-cohttp-lwt</a> &#x00BB; <a href="../index.html">Multipart_form_cohttp</a> &#x00BB; Server</nav><header class="odoc-preamble"><h1>Module <code><span>Multipart_form_cohttp.Server</span></code></h1></header><div class="odoc-content"><div class="odoc-spec"><div class="spec exception" id="exception-Invalid_multipart_form" class="anchored"><a href="#exception-Invalid_multipart_form" class="anchor"></a><code><span><span class="keyword">exception</span> </span><span><span class="exception">Invalid_multipart_form</span> <span class="keyword">of</span> string</span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-multipart_form" class="anchored"><a href="#val-multipart_form" class="anchor"></a><code><span><span class="keyword">val</span> multipart_form : 
  <span>identify:<span>( <span><span class="xref-unresolved">Cohttp</span>.Header.t <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'id</span> )</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="xref-unresolved">Cohttp</span>.Request.t <span class="arrow">&#45;&gt;</span></span>
  <span><span class="xref-unresolved">Cohttp_lwt</span>.Body.t <span class="arrow">&#45;&gt;</span></span>
  <span>[ <span>`Tree of <span><span><span class="type-var">'id</span> <a href="../../../multipart_form/Multipart_form/index.html#type-t">Multipart_form.t</a></span> <span class="xref-unresolved">Lwt</span>.t</span></span> ]</span>
  * <span><span>(<span class="type-var">'id</span> * <span class="xref-unresolved">Cohttp</span>.Header.t * <span class="xref-unresolved">Cohttp_lwt</span>.Body.t)</span> <span class="xref-unresolved">Lwt_stream</span>.t</span></span></code></div><div class="spec-doc"><p><code>multipart_form ~identify req body</code> returns a <i>fiber</i> which parses the given <code>body</code> and a stream of each part of the given <code>body</code>. The goal is to propose an easier interface specially for CoHTTP. By this way, this function expects a CoHTTP request and a CoHTTP body.</p><p>To consume the returned stream, the returned <i>fiber</i> must be launched:</p><pre><code>let consume_parts stream =
  let* part = Lwt_stream.get stream in
  match part with
  | None -&gt; ...
  | Some (uid, headers, body) -&gt; ...

let handler _ req body =
  let `Tree th, stream = Multipart_form_cohttp.Server.multipart_form
    ~identify req body in
  Lwt.catch begin fun () -&gt;
    let* tree, _ = Lwt.both (th, consume_parts stream) in
    ...
  end @@ function
  | Invalid_multipart_form err -&gt; ...</code></pre><p>In this example, we use <code>Lwt.both</code> to concurrently parse and consume parts. If the body is not a valid <code>multipart-form/data</code>, the exception <a href="#exception-Invalid_multipart_form"><code>Invalid_multipart_form</code></a> is raised.</p></div></div></div></body></html>